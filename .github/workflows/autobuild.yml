name: Create the DEB
on:
  workflow_dispatch:
jobs:
  Create_Packages:
    name: Create Package
    runs-on: ubuntu-latest
    steps:
      - name: Configure GPG Key
        run: |
          echo -n "$GPG_SIGNING_KEY" | gpg --import --batch
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
      - name: Add the custom gpg signing program
        run: |
          cat > /tmp/sign.sh << EOF
          #!/bin/bash
          gpg --batch --pinentry-mode=loopback --passphrase $GPG_KEY_PASSPHRASE $@
          EOF
          cat /tmp/sign.sh
          chmod +x /tmp/sign.sh
        env:
          GPG_KEY_PASSPHRASE: ${{ secrets.GPG_KEY_PASSPHRASE }}
      - name: Install package
        run: |
          sudo apt-get install dpkg-dev devscripts debhelper
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: repo
      - name: Build pacakge
        run: |
          cd repo/contrib/hello
          key=$(gpg --list-secret-keys --with-colons |  awk -F: '/^fpr:/ { print $10 }')
          echo $key
          dpkg-buildpackage -S --sign-key="$key" --sign-command=/tmp/sign.sh
      - name: Upload to PPA
        run: |
          dput ppa:dirksu/test *.changes
